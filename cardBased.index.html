<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Atlas</title>
	<link rel="stylesheet" type="text/css" href="./css/myStyle.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/solid.css" integrity="sha384-v2Tw72dyUXeU3y4aM2Y0tBJQkGfplr39mxZqlTBDUZAb9BGoC40+rdFCG0m10lXk" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/fontawesome.css" integrity="sha384-q3jl8XQu1OpdLgGFvNRnPdj5VIlCvgsDQTQB6owSOHWlAurxul7f+JpUOVdAiJ5P" crossorigin="anonymous">
	<script type="text/javascript">
		mxBasePath = './mxgraph';
	</script>

	<script src="./js/cardBased/CBFeature.js"></script>
	<script src="./js/cardBased/CBGraph.js"></script>
	<script src="./js/cardBased/CBAssociation.js"></script>
	<script src="./js/cardBased/CBCreateFeature.js"></script>
	<script src="./js/cardBased/CBAlternativeAssociation.js"></script>
	<script src="./js/cardBased/CBChangeType.js"></script>
	<script src="./js/Modal.js"></script>
	<script src="./js/AdjustCanvas.js"></script>
	<script src="./js/Download.js"></script>
	<script src="./js/cardBased/CBLoadXml.js"></script>
	<script src="./js/SavePng.js"></script>
	<script src="./js/cardBased/CBValidationScript.js"></script>

	<script type="text/javascript" src="./mxgraph/mxClient.js"></script>

	<script type="text/javascript">
		var grafo;
		var rubberband;
		var layout;
var undoManager;
		function main(container) {
			mxEvent.disableContextMenu(document.body);
			var graph = new mxGraph(container);



			style = graph.getStylesheet().getDefaultEdgeStyle();
			style[mxConstants.STYLE_ENDARROW] = mxConstants.d;
			style[mxConstants.STYLE_STROKECOLOR] = 'black';


			mxStyleRegistry.putValue('roundedStyle', mxEdgeStyle.MyStyle);


			graph.setConnectable(true);
			graph.setPortsEnabled(false);


			var ports = new Array();
			ports['n'] = {
				x: 0.5,
				y: 0,
				perimeter: true,
				constraint: 'north'
			};
			ports['s'] = {
				x: 0.5,
				y: 1,
				perimeter: true,
				constraint: 'south'
			};


			mxShape.prototype.getPorts = function() {
				return ports;
			};

			graph.connectionHandler.isConnectableCell = function(cell) {
				return false;
			};
			mxEdgeHandler.prototype.isConnectableCell = function(cell) {
				return graph.connectionHandler.isConnectableCell(cell);
			};

			mxGraphHandler.prototype.moveEnabled = false;
			// Disables existing port functionality
			graph.view.getTerminalPort = function(state, terminal, source) {
				return terminal;
			};

			graph.getConnectionConstraint = function(edge, terminal, source) {
				var key = (source) ? mxConstants.STYLE_SOURCE_PORT : mxConstants.STYLE_TARGET_PORT;
				var id = edge.style[key];

				if (id != null) {
					var c = new mxConnectionConstraint(null, null);
					c.id = id;

					return c;
				}

				return null;
			};

			graphGetConnectionPoint = graph.getConnectionPoint;
			graph.getConnectionPoint = function(vertex, constraint) {
				if (constraint.id != null && vertex != null && vertex.shape != null) {
					var port = vertex.shape.getPorts()[constraint.id];

					if (port != null) {
						constraint = new mxConnectionConstraint(new mxPoint(port.x, port.y), port.perimeter);
					}
				}

				return graphGetConnectionPoint.apply(this, arguments);
			};


			rubberband = new mxRubberband(graph);
			var keyHandler = new mxKeyHandler(graph);

			grafo = new Graph(graph);
			grafo.model.container.style.backgroundColor = 'white';
			layout = new mxCompactTreeLayout(grafo.model, false);

			var parent = grafo.model.getDefaultParent();
			createStyles();


			grafo.model.centerZoom = false;

			graph.addListener(mxEvent.DOUBLE_CLICK, function(sender, evt) {
				var cell = evt.getProperty('cell');
				console.log(cell);
				if(cell.isVertex()==true){
					grafo.renameFeature(cell);
					evt.consume();
				}

			});


			document.body.appendChild(mxUtils.button('View XML', function() {
				var encoder = new mxCodec();
				var node = encoder.encode(graph.getModel());
				mxUtils.popup(mxUtils.getXml(node), true);
			}));

			undoManager = new mxUndoManager();
			console.log(undoManager);
			var listener = function(sender, evt) {
				undoManager.undoableEditHappened(evt.getProperty('edit'));
			};
			grafo.model.getModel().addListener(mxEvent.UNDO, listener);
			grafo.model.getView().addListener(mxEvent.UNDO, listener);


			var mxCellRendererInstallCellOverlayListeners = mxCellRenderer.prototype.installCellOverlayListeners;
			mxCellRenderer.prototype.installCellOverlayListeners = function(state, overlay, shape) {
				mxCellRendererInstallCellOverlayListeners.apply(this, arguments);
				var graph = state.view.graph;

				mxEvent.addGestureListeners(shape.node,
					function(evt) {
						graph.fireMouseEvent(mxEvent.MOUSE_DOWN, new mxMouseEvent(evt, state));
					},
					function(evt) {
						graph.fireMouseEvent(mxEvent.MOUSE_MOVE, new mxMouseEvent(evt, state));
					},
					function(evt) {
						if (mxClient.IS_QUIRKS) {
							graph.fireMouseEvent(mxEvent.MOUSE_UP, new mxMouseEvent(evt, state));
						}
					});

				if (!mxClient.IS_TOUCH) {
					mxEvent.addListener(shape.node, 'mouseup', function(evt) {
						overlay.fireEvent(new mxEventObject(mxEvent.CLICK,
							'event', evt, 'cell', state.cell));
					});
				}
			};


			mxEvent.addMouseWheelListener(function(evt, up) {
				if (!mxEvent.isConsumed(evt)) {
					if (up) {
						grafo.model.zoomIn();
					} else {
						grafo.model.zoomOut();
					}

					mxEvent.consume(evt);
				}
			});

			// Configures automatic expand on mouseover
			graph.popupMenuHandler.autoExpand = true;

			// Installs context menu
			graph.popupMenuHandler.factoryMethod = function(menu, cell, evt) {
				if (cell != null) {
					if (grafo.model.getModel().isVertex(cell)) {
						menu.addItem('Make Mandatory', null, function() {
							changeTypeFeature([cell], 'mandatory');
						});

						menu.addItem('Make Optional', null, function() {
							changeTypeFeature([cell], 'optional');
						});

						menu.addItem('Make Alternative', null, function() {
							changeTypeFeature([cell], 'alternative');
						});

						menu.addItem('Remove Feature', null, function() {
							grafo.removeFeature([cell]);

						});
					}
				} else {
					menu.addItem('Create Feature', null, function() {
						showPopUp(modalFeature);
					});

					menu.addItem('Create Association', null, function() {
						showPopUp(modalAssociation);
					});
				}
			};
			adjustSizes();
			adjustTooltips();
		};


		mxEdgeStyle.MyStyle = function(state, source, target, points, result) {
			if (source != null && target != null) {
				var cont = grafo.model.getEdges(source.cell.source, grafo.model.getDefaultParent(), false, true, false, false);

				var pt = new mxPoint(source.getCenterX(), target.getCenterY());

				if (mxUtils.contains(source, pt.x, pt.y)) {
					if (cont.length > 2) {
						pt.y = source.y + source.height - 5;

						pt.x = target.x + ((cont.length - 2) * 10);
					} else {
						pt.y = source.y + source.height;

						pt.x = target.x;
					}

				}

				result.push(pt);
			}

		};
	</script>


</head>

<body onload="main(document.getElementById('graphContainer'))">
	<!--Top Bar-->
	<div class="topBar">
		<input id="modelName" class="modelName" type="text" placeholder="Model name">
		<div class="topBarIconGroup" id="topBarIconGroup">
			<a onclick="undoManager.undo()" href="javascript:void(0);">
	                <span class="tooltip">Undo</span>
	                <i class="fas fa-undo"></i> </a>
			<a onclick="undoManager.redo()" href="javascript:void(0);">
							    <span class="tooltip">Undo</span>
							    <i class="fas fa-redo"></i> </a>
			<a onclick="grafo.clearGraph()" href="javascript:void(0);">
							    <span class="tooltip">Create Model</span>
			            <i class="fa fa-file"></i> </a>
			<a onclick="createLoadModalButtonClick()" href="javascript:void(0);">
	                <span class="tooltip">Load Model</span>
	                <i class="fa fa-upload"></i> </a>
			<a onclick="grafo.getXml()" href="javascript:void(0);">
	                <span class="tooltip">Save as .xml</span>
	                <i class="fa fa-save"></i> </a>
			<a onclick="show()" href="javascript:void(0)">
	                <span class="tooltip">Print</span>
	                <i class="fa fa-print"></i> </a>
		</div>
	</div>


	<!--Top Bar Small Screen < 600 width-->
	<div class="topBarIconGroupSmall" id="topBarIconGroupSmall">
		<a onclick="undoManager.undo()" href="javascript:void(0);">
								<span class="tooltip">Undo</span>
								<i class="fas fa-undo"></i> </a>
		<a onclick="undoManager.redo()" href="javascript:void(0);">
			                <span class="tooltip">Redo</span>
			                <i class="fas fa-redo"></i> </a>
		<a onclick="createLoadModalButtonClick()" href="javascript:void(0);">
			            <span class="tooltip">Load Model</span>
			            <i class="fa fa-upload"></i> </a>
		<a onclick="grafo.getXml()" href="javascript:void(0);">
			            <span class="tooltip">Save as .xml</span>
			            <i class="fa fa-save"></i> </a>
		<a onclick="show()" href="javascript:void(0)">
			            <span class="tooltip">Print</span>
			            <i class="fa fa-print"></i> </a>
	</div>

	<!--Side Bar-->
	<div class="sideBar">
		<div class="sideBarIconGroup">
			<a onclick="showPopUp(modalFeature);" href="javascript:void(0);">
			                <span class="tooltip">Create Feature</span>
			                <i class="fas fa-plus-square"></i></a>
			<a onclick="showPopUp(modalAssociation);" href="javascript:void(0);">
			                <span class="tooltip">Create Association</span>
			                <i class="fas fa-arrows-alt-v"></i></a>
			<a onclick="validateModel()" href="javascript:void(0);">
			                <span class="tooltip">Check Model</span>
			                <i class="fa fa-check"></i></a>

		</div>
	</div>

	<!--Create Feature Modal-->
	<div class="modal" id="modalFeature">
		<div id="featureModalContent" class="featureModalContent">
			<div class="closeButton">
				<a onclick="closePopUp(modalFeature);" href="javascript:void(0);"><i class="fa fa-times"></i></a>
			</div>
			<label><b>Feature Name</b></label>
			<input id="featureName2" type="text" name="Fname" value="">
			<label><b>Feature type</b></label>
			<select id="featureType2">
	    <option value="mandatory" >Mandatory</option>
	    <option value="optional" >Optional</option>
	    <option value="alternative" >Alternative</option>
	</select>
			<button id="createFeatureSubmitButton" onclick="createFeature(featureName2.value,featureType2.value)" type="submit">Create</button>
		</div>
	</div>

	<!--Create Association Modal-->
	<div class="modal" id="modalAssociation">
		<div id="associationModalContent" class="associationModalContent">
			<div class="closeButton">
				<a onclick="closePopUp(modalAssociation);" href="javascript:void(0);"><i class="fa fa-times"></i></a>
			</div>
			<label><b>Parent Feature</b></label>
			<select id="feature1id2" onchange="grafo.setSelectBoxChild()"></select>
			<label><b>Child Feature</b></label>
			<select id="feature2id2"></select>
			<button id="createAssociationSubmitButton" onclick="createAssociation(feature1id2.value,feature2id2.value)" type="submit">Create</button>
		</div>
	</div>

	<!--Load File Modal-->
	<div class="modal" id="loadFileModal">
		<div id="loadFileModalContent" class="loadFileModalContent">
			<div class="closeButton"> <a onclick="closePopUp(loadFileModal);" href="javascript:void(0);"><i class="fa fa-times"></i></a><br/>
			</div>
			<label><b>Select File</b></label><br/>
			<input id="fileInput" type="file" accept=".xml" value="select"><br/>
			<button id="loadFileSubmitButton" onclick="loadFile(grafo.model)" type="submit">Import</button>
		</div>
	</div>

	<!--Canvas-->
	<div class="canvas" id="canvas">
		<div id="graphContainer">

		</div>


	</div>

</body>

</html>
